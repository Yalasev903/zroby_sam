<?php

namespace App\Listeners;

use Illuminate\Auth\Events\Registered;
use App\Models\AdminSetting;
use App\Models\Notification;

class SendAutoGreeting
{
    // Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    protected static $processed = [];

    /**
     * ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸.
     *
     * @param Registered $event
     * @return void
     */
    public function handle(Registered $event)
    {
        $user = $event->user;

        // Ğ•ÑĞ»Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾, Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼
        if (isset(self::$processed[$user->id])) {
            return;
        }
        self::$processed[$user->id] = true;

        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
        $adminSetting = AdminSetting::first();

        if ($adminSetting && $adminSetting->auto_greeting_enabled) {
            $greetingText = $adminSetting->auto_greeting_text ?? 'Ğ—Ñ€Ğ¾Ğ±Ğ¸ Ğ¡Ğ°Ğ¼ â€“ Ñ†Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾ÑˆÑƒĞºÑƒ ÑĞ¿ĞµÑ†Ñ–Ğ°Ğ»Ñ–ÑÑ‚Ñ–Ğ² Ñ‚Ğ° Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ²Ñ†Ñ–Ğ². ğŸš€';

            // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸ĞµĞ¼
            Notification::create([
                'user_id' => $user->id,
                'title'   => 'ğŸ‰ Ğ’Ñ–Ñ‚Ğ°Ñ”Ğ¼Ğ¾, ' . $user->name . '!',
                'message' => 'ĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚, ' . $user->name . '! ğŸ˜Š Ğ Ğ°Ğ´Ğ¸Ğ¹ Ğ±Ğ°Ñ‡Ğ¸Ñ‚Ğ¸ Ñ‚ĞµĞ±Ğµ Ğ½Ğ° Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ– "Ğ—Ñ€Ğ¾Ğ±Ğ¸ Ğ¡Ğ°Ğ¼"! ğŸˆ ' . $greetingText,
                'read'    => false,
            ]);

            // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹
            Notification::create([
                'user_id' => $user->id,
                'title'   => 'â„¹ï¸ Ğ¯Ğº Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ½Ğ°ÑˆĞ° Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°?',
                'message' => 'ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚, ' . $user->name . '! ĞĞ°Ñˆ Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‰Ğ¾Ğ± Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ²Ñ†Ñ– Ñ‚Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ½Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ğ»Ğ¸ Ñ€Ğ°Ğ·Ğ¾Ğ¼ Ñƒ Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… ÑÑ„ĞµÑ€Ğ°Ñ… Ğ´Ñ–ÑĞ»ÑŒĞ½Ğ¾ÑÑ‚Ñ–. ğŸ› ï¸ Ğ¢ÑƒÑ‚ Ñ‚Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑˆ Ğ·Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑ–Ğ¾Ğ½Ğ°Ğ»Ğ° Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑŒ-ÑĞºĞ¾Ñ— ÑĞ¿Ñ€Ğ°Ğ²Ğ¸ Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ Ğ½Ğ° Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ, Ñ‰Ğ¾Ğ± Ğ¿Ñ€Ğ¾Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ ÑĞ²Ğ¾Ñ— Ğ½Ğ°Ğ²Ğ¸Ñ‡ĞºĞ¸ Ñ‚Ğ° Ğ·Ğ°Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³! â­',
                'read'    => false,
            ]);
        }
    }
}
